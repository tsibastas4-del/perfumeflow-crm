<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>✨ PerfumeFlow Pro v18.1 (Smart Fix)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7c3aed">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fa-solid fa-spray-can-sparkles"></i> PerfumeFlow
        </div>

        <!-- Mobile Top Controls (will be positioned absolutely on mobile via CSS if needed, or we add a specific class) -->
        <div class="navbar-controls" style="display: flex; align-items: center; gap: 10px;">
            <button class="theme-toggle" onclick="toggleTheme()" title="Змінити тему">
                <i id="theme-icon" class="fa-solid fa-moon"></i>
            </button>
            <button class="theme-toggle" onclick="openSettingsModal()" style="margin-left: 5px;"><i
                    class="fa-solid fa-cog"></i></button>
        </div>

        <div class="navbar-links">
            <button class="nav-btn active" onclick="showSection('dashboard', this)"><i
                    class="fa-solid fa-chart-pie"></i> Головна</button>
            <button class="nav-btn" onclick="showSection('multi-calculator', this)"><i
                    class="fa-solid fa-list-check"></i> Замовлення</button>
            <button class="nav-btn" onclick="showSection('transactions', this)"><i
                    class="fa-solid fa-clock-rotate-left"></i> Історія</button>
            <button class="nav-btn" onclick="showSection('tasks', this)"><i class="fa-solid fa-clipboard-list"></i>
                Задачі</button>
            <button class="nav-btn" onclick="showSection('ai-assistant', this)"><i class="fa-solid fa-robot"></i>
                AI Помічник</button>
            <button class="nav-btn" onclick="showSection('smm-creator', this)"><i class="fa-solid fa-camera-retro"></i>
                SMM</button>
            <button class="nav-btn" onclick="showSection('admin-panel', this)"><i class="fa-solid fa-gears"></i>
                Адмінка</button>
        </div>
    </nav>

    <div id="toast-container"></div>

    <div class="container">

        <section id="dashboard" class="content-section active">
            <h2>👋 Вітаємо! Огляд за сьогодні</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Виручка сьогодні</h3>
                    <div class="value" id="dash-revenue">0 ₴</div>
                </div>
                <div class="stat-card green">
                    <h3>Прибуток сьогодні</h3>
                    <div class="value" id="dash-profit">0 ₴</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                    <h3>Продажів</h3>
                    <div class="value" id="dash-count">0</div>
                </div>
                <div class="stat-card danger" id="dash-low-stock-count">
                    <h3>Низький Запас</h3>
                    <div class="value" id="dash-low-stock-count-value">0</div>
                </div>
            </div>

            <!-- CHARTS SECTION -->
            <div class="grid-2-col" style="margin-bottom: 20px;">
                <div class="card">
                    <h3>📈 Динаміка продажів (30 днів)</h3>
                    <canvas id="salesChart"></canvas>
                </div>
                <div class="card">
                    <h3>🏆 Популярні аромати</h3>
                    <canvas id="topProductsChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3><i class="fa-solid fa-trophy"></i> Топ-5 Популярних Ароматів (за об'ємом)</h3>
                <div class="table-responsive">
                    <table id="top-products-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Назва Парфуму</th>
                                <th class="text-right">Продано</th>
                                <th class="text-right">Виручка</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3><i class="fa-solid fa-bolt"></i> Швидкі дії</h3>
                <div class="grid-2-col">
                    <button class="btn-primary"
                        onclick="showSection('multi-calculator', document.querySelectorAll('.nav-btn')[1])"><i
                            class="fa-solid fa-plus"></i> Нове Замовлення</button>
                    <button class="btn-success"
                        onclick="showSection('tasks', document.querySelectorAll('.nav-btn')[4])"><i
                            class="fa-solid fa-clipboard-list"></i> Переглянути Задачі</button>
                </div>
            </div>
        </section>

        <section id="tasks" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-list-check"></i> Керування Задачами</h2>

                <div class="task-tabs">
                    <div class="task-tab active" onclick="switchTaskTab('orders')" id="tab-orders">
                        📦 Замовлення
                    </div>
                    <div class="task-tab" onclick="switchTaskTab('manual')" id="tab-manual">
                        📝 Ручні Задачі
                    </div>
                </div>

                <!-- Orders Tasks Tab -->
                <div id="task-view-orders">
                    <div id="orders-task-list" class="task-container">
                        <!-- Order tasks populated here -->
                    </div>
                </div>

                <!-- Manual Tasks Tab -->
                <div id="task-view-manual" style="display: none;">
                    <div
                        style="margin-bottom: 20px; padding: 15px; background: rgba(var(--primary-rgb), 0.05); border-radius: 12px;">
                        <h3 style="margin-top: 0;"><i class="fa-solid fa-robot"></i> AI Створення Задачі</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">
                            Вставте будь-який текст (нотатку, повідомлення), і AI створить структуровану задачу.
                        </p>
                        <textarea id="manualTaskInput"
                            placeholder="Напр: Треба відправити 5мл Баккари для Олени завтра зранку..."
                            style="width: 100%; min-height: 80px; margin-bottom: 10px;"></textarea>
                        <button class="btn-primary" onclick="createManualTaskAI()">
                            <i class="fa-solid fa-magic"></i> Створити задачу за допомогою AI
                        </button>
                    </div>
                    <div id="manual-task-list" class="task-container">
                        <!-- Manual tasks populated here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- REMOVED: QUICK SALE SECTION (input-form) -->

        <section id="multi-calculator" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-basket-shopping"></i> Кошик Замовлення</h2>
                <div class="grid-3-col" style="margin-bottom: 15px;">
                    <div><label>Націнка</label><select id="saleMarkupTierOrder"></select></div>
                    <div><label>Джерело</label><select id="saleSourceOrder"></select></div>
                    <div><label>Клієнт</label><input type="text" id="clientNameOrder" placeholder="Ім'я клієнта"
                            list="clientList" onchange="checkClientLoyalty(this)"></div>
                    <div>
                        <label>Знижка (%)</label>
                        <select id="discountSelectOrder" style="border: 2px solid var(--border);">
                            <option value="0">0%</option>
                            <option value="1">1%</option>
                            <option value="2">2%</option>
                            <option value="3">3%</option>
                            <option value="4">4%</option>
                            <option value="5">5%</option>
                        </select>
                    </div>
                </div>

                <!-- ORDER PARSER -->
                <div class="parser-area">
                    <label>Вставити текст з месенджера:</label>
                    <textarea id="pasteAreaOrder" placeholder="Вставте текст сюди..."></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn-primary" onclick="smartParseAI('order')"
                            style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                            <i class="fa-solid fa-robot"></i> AI Розбір
                        </button>
                    </div>
                </div>

                <h3 style="margin-top: 20px;"><i class="fa-solid fa-truck-moving"></i> Реквізити для відправки</h3>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>Номер телефону</label><input type="text" id="phoneOrder" placeholder="+380..."></div>
                    <div><label>ПІБ (повністю)</label><input type="text" id="fullNameOrder"
                            placeholder="Іванов Іван..."></div>
                    <div><label>Місто</label><input type="text" id="cityOrder" placeholder="Напр: Київ"></div>
                    <div><label>Відділення НП</label><input type="text" id="postOfficeOrder"
                            placeholder="№X або Адреса"></div>
                </div>
                <label>Коментар до замовлення</label>
                <textarea id="commentsOrder" rows="2" placeholder="Напр: Скинути реквізити на Вайбер..."
                    style="margin-bottom: 20px;"></textarea>
                <div
                    style="background: var(--bg-input); padding: 15px; border-radius: 8px; border: 1px dashed var(--border); margin-bottom: 15px;">
                    <div class="grid-2-col">
                        <div><label>Парфум</label><input type="text" id="orderPerfumeName" list="perfumeList"></div>
                        <div><label>Об'єм</label><select id="orderFlaconVolume"></select></div>
                    </div>
                    <button class="btn-warning" style="margin-top: 10px;" onclick="addItemToOrder()"><i
                            class="fa-solid fa-plus-circle"></i> Додати позицію</button>
                </div>

                <div class="table-responsive">
                    <table id="order-list-table">
                        <thead>
                            <tr>
                                <th>Парфум</th>
                                <th class="text-right">Об'єм</th>
                                <th class="text-right">Ціна</th>
                                <th class="text-right">Дія</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="orderTotalSection"
                    style="margin: 20px 0; font-size: 1.2rem; font-weight: bold; text-align: right; color: var(--primary);">
                </div>

                <h3 style="margin-top: 20px;"><i class="fa-solid fa-copy"></i> Текст замовлення (для Клієнта)</h3>
                <textarea id="orderSummaryOutput" rows="8" readonly placeholder="Текст замовлення з'явиться тут..."
                    style="margin-bottom: 10px;"></textarea>
                <button class="btn-warning" onclick="copyOrderSummary()"><i class="fa-solid fa-copy"></i> Копіювати
                    текст</button>
                <button class="btn-primary" onclick="generateAIOrderMessage()"
                    style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                    <i class="fa-solid fa-robot"></i> 🤖 ШІ Повідомлення
                </button>
                <label>Номер ТТН (опційно)</label>
                <input type="text" id="ttnNumberOrder" placeholder="Номер ТТН" style="margin-bottom: 20px;">

                <div class="grid-2-col" style="margin-top: 20px;">
                    <button class="btn-success" onclick="processOrder()" id="processOrderBtn"><i
                            class="fa-solid fa-cash-register"></i> Оформити</button>
                    <button class="btn-danger" onclick="clearOrder()"><i class="fa-solid fa-trash"></i>
                        Очистити</button>
                </div>
            </div>
        </section>

        <section id="report" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-chart-line"></i> Звітність</h2>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>З дати</label><input type="date" id="startDate"></div>
                    <div><label>По дату</label><input type="date" id="endDate"></div>
                </div>
                <button class="btn-primary" onclick="generateReport()"><i class="fa-solid fa-filter"></i> Сформувати
                    Звіт</button>
                <div id="reportOutput" style="margin-top: 20px;"></div>
            </div>
        </section>

        <section id="transactions" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-history"></i> Історія Продажів</h2>

                <!-- Week Navigation -->
                <div class="week-navigation">
                    <button class="btn-sm btn-primary" onclick="navigateWeek(-1)">
                        <i class="fa-solid fa-chevron-left"></i> Попередній тиждень
                    </button>
                    <div class="current-week-display">
                        <strong id="currentWeekLabel">Поточний тиждень</strong>
                    </div>
                    <button class="btn-sm btn-primary" onclick="navigateWeek(1)" id="nextWeekBtn">
                        Наступний тиждень <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
                <div class="grid-3-col" style="margin-bottom: 15px;">
                    <div><input type="text" id="transactionSearch" onkeyup="renderTransactionHistory()"
                            placeholder="🔍 Пошук..."></div>
                    <div><select id="historyFilterSource" onchange="renderTransactionHistory()"></select></div>
                    <div><input type="date" id="historyStartDate" onchange="renderTransactionHistory()"></div>
                </div>

                <div class="table-responsive">
                    <table id="transaction-history-table">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Клієнт</th>
                                <th>Джерело</th>
                                <th>ТТН</th>
                                <th>Парфум</th>
                                <th class="text-right">Сума</th>
                                <th class="text-right">Прибуток</th>
                                <th class="text-right">Дія</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="transactionSummary" style="margin-top: 15px; font-weight: 600; text-align: right;"></p>
            </div>
        </section>

        <section id="client-crm" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-users"></i> CRM Клієнтів</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="clientSearchInput" list="clientList" placeholder="Введіть ім'я клієнта...">
                    <button class="btn-primary" style="width: auto;" onclick="showClientHistory()"><i
                            class="fa-solid fa-search"></i> Знайти</button>
                    <button id="aiClientAnalysisBtn" class="btn-primary"
                        style="width: auto; background: linear-gradient(135deg, #ec4899, #8b5cf6); display: none;"
                        onclick="analyzeClientPreferences()">
                        <i class="fa-solid fa-tags"></i> 🏷️ ШІ Аналіз уподобань
                    </button>
                </div>
                <div id="clientCrmSummary"></div>
                <div class="table-responsive">
                    <table id="client-history-table">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Парфум</th>
                                <th class="text-right">Сума</th>
                                <th class="text-right">Прибуток</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="admin-panel" class="content-section">
            <div class="grid-2-col" style="margin-bottom: 20px;">
                <button class="btn-primary" onclick="showSection('report', null)">📊 Фінансові звіти</button>
                <button class="btn-primary" onclick="showSection('client-crm', null)">👥 База клієнтів (CRM)</button>
                <button class="btn-primary" onclick="showSection('expenses', null)">💸 Додати Витрату</button>
                <button class="btn-primary" onclick="showSection('calculator', null)">🧮 Калькулятор ціни</button>
            </div>

            <div class="card">
                <h2><i class="fa-solid fa-warehouse"></i> Складський облік</h2>
                <div class="scanner-box">
                    <label>👋 Сканувати Штрих-код для додавання **500 мл** (Автоматично)</label>
                    <input type="text" id="inventoryBarcodeScan" placeholder="Наведіть сканер..."
                        onchange="scanBarcodeForStock(this.value); this.value='';"
                        onkeydown="if(event.key === 'Enter'){ event.preventDefault(); scanBarcodeForStock(this.value); this.value=''; return false; }">
                </div>

                <h3 style="margin-top: 20px;"><i class="fa-solid fa-plus-square"></i> Додати/Списати (Вручну)</h3>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>Парфум</label><input type="text" id="inventoryPerfumeName" list="perfumeList"></div>
                    <div><label>Об'єм (мл)</label><input type="number" id="inventoryVolume" placeholder="Напр: 500">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-primary" onclick="addStock()" style="width: auto;"><i
                            class="fa-solid fa-plus-square"></i> Додати Запас</button>
                    <button class="btn-primary" onclick="generateStockForecast()"
                        style="background: linear-gradient(135deg, #f59e0b, #d97706); width: auto;">
                        <i class="fa-solid fa-chart-line"></i> 📊 ШІ Прогноз Залишків
                    </button>
                </div>

                <div id="stockForecastResult" style="display: none; margin-bottom: 20px;">
                    <div class="card"
                        style="background: rgba(var(--primary-rgb), 0.05); border-left: 5px solid #f59e0b; padding: 20px;">
                        <h3>📈 Аналіз та Прогноз залишків</h3>
                        <div id="stockForecastContent" style="font-size: 0.95rem; line-height: 1.6;"></div>
                        <button class="btn-sm btn-danger" style="margin-top: 15px; width: auto;"
                            onclick="document.getElementById('stockForecastResult').style.display='none'">Закрити
                            звіт</button>
                    </div>
                </div>

                <h4 style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">Поточні залишки:
                </h4>

                <div class="filter-bar">
                    <div class="filter-group">
                        <button class="filter-chip active" onclick="filterStockByGender('all', this)">Всі</button>
                        <button class="filter-chip" onclick="filterStockByGender('Жіночий', this)">👩 Жіночі</button>
                        <button class="filter-chip" onclick="filterStockByGender('Чоловічий', this)">👨
                            Чоловічі</button>
                        <button class="filter-chip" onclick="filterStockByGender('Унісекс', this)">🚻 Унісекс</button>
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table id="inventory-list-table">
                        <thead>
                            <tr>
                                <th>Назва</th>
                                <th class="text-right">Залишок (мл)</th>
                                <th class="text-right">Дія</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-file-invoice"></i> Прайс-лист для клієнтів (Ціна за мл)</h3>
                <label>Виберіть націнку для прайсу:</label>
                <select id="priceListMarkup"></select>
                <button class="btn-warning" style="margin-top: 10px;" onclick="generatePriceList()"><i
                        class="fa-solid fa-list-ul"></i> Сформувати та скопіювати</button>
                <textarea id="priceListOutput" rows="10" readonly
                    placeholder="Тут буде згенерований прайс-лист для копіювання..."
                    style="margin-top: 15px;"></textarea>
            </div>

            <div class="card">
                <h2><i class="fa-solid fa-database"></i> Довідник Парфумів</h2>
                <div class="admin-form-box">
                    <div class="grid-3-col" style="margin-bottom: 10px;">
                        <div>
                            <label>Назва парфуму</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="text" id="adminPerfumeName" placeholder="Назва парфуму">
                                <button class="btn-primary" onclick="autoFillPerfumeData()"
                                    title="✨ AI Автозаповнення за назвою" style="width: auto; padding: 0 15px;">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI
                                </button>
                            </div>
                        </div>
                        <div><label>С/С (грн/мл)</label><input type="number" id="adminBasePrice" placeholder="0.00">
                        </div>
                        <div><label>Штрих-код</label><input type="text" id="adminBarcode" placeholder="Barcode"></div>
                        <div>
                            <select id="adminGender">
                                <option value="">Оберіть стать</option>
                                <option value="Жіночий">👩 Жіночий</option>
                                <option value="Чоловічий">👨 Чоловічий</option>
                                <option value="Унісекс">🚻 Унісекс</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid-2-col" style="margin-bottom: 10px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="margin-bottom: 0; white-space: nowrap;">Сезон:</label>
                            <label style="display: inline-flex; align-items: center; gap: 4px; font-weight: 400;"><input
                                    type="checkbox" name="adminSeason" value="Літо" style="width: auto;"> ☀️
                                Літо</label>
                            <label style="display: inline-flex; align-items: center; gap: 4px; font-weight: 400;"><input
                                    type="checkbox" name="adminSeason" value="Зима" style="width: auto;"> ❄️
                                Зима</label>
                        </div>
                        <input type="text" id="adminTags" placeholder="Теги (через кому: свіжий, амбра...)">
                    </div>
                    <div class="grid-2-col" style="margin-bottom: 10px;">
                        <input type="number" id="adminDiscountVolume" placeholder="Об'єм для знижки (мл)" value="5">
                        <input type="number" id="adminDiscountPrice" placeholder="С/С зі знижкою (грн/мл)">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label>Піраміда аромату (Верхні, серце, база)</label>
                        <textarea id="adminPyramid" rows="2"
                            placeholder="Напр: Верхні: Лимон, М'ята; Ноти серця: Жасмин; База: Кедр..."></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>Опис аромату (характер, для кого, куди носити)</label>
                        <textarea id="adminDescription" rows="3" placeholder="Опишіть аромат детально..."></textarea>
                    </div>
                    <button class="btn-success" onclick="addOrUpdatePerfume()"><i class="fa-solid fa-save"></i>
                        Зберегти/Оновити</button>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <button class="filter-chip active"
                            onclick="setCatalogFilter('gender', 'all', this)">Всі</button>
                        <button class="filter-chip" onclick="setCatalogFilter('gender', 'Жіночий', this)">👩
                            Жіночі</button>
                        <button class="filter-chip" onclick="setCatalogFilter('gender', 'Чоловічий', this)">👨
                            Чоловічі</button>
                        <button class="filter-chip" onclick="setCatalogFilter('gender', 'Унісекс', this)">🚻
                            Унісекс</button>
                    </div>
                    <div class="filter-group">
                        <button class="filter-chip active" onclick="setCatalogFilter('season', 'all', this)">Будь-який
                            сезон</button>
                        <button class="filter-chip" onclick="setCatalogFilter('season', 'Літо', this)">☀️ Літні</button>
                        <button class="filter-chip" onclick="setCatalogFilter('season', 'Зима', this)">❄️
                            Зимові</button>
                    </div>
                </div>

                <input type="text" id="perfumeSearchInput" onkeyup="renderPerfumeList()"
                    placeholder="🔍 Пошук у довіднику..." style="margin-bottom: 10px;">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table id="perfume-list-table">
                        <thead>
                            <tr>
                                <th>Назва</th>
                                <th class="text-right">С/С</th>
                                <th class="text-right">Дія</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-flask"></i> Флакони & Налаштування</h3>
                <div class="grid-2-col">
                    <div>
                        <label>Додати Флакон (Об'єм / Ціна)</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="adminFlaconVolume" placeholder="мл">
                            <input type="number" id="adminFlaconCost" placeholder="грн">
                            <button class="btn-success" style="width: auto;" onclick="addOrUpdateFlacon()"><i
                                    class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div>
                        <label>Додати Націнку (Назва / Коеф)</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="adminMarkupName" placeholder="Напр: VIP">
                            <input type="number" id="adminMarkupValue" placeholder="0.10">
                            <button class="btn-success" style="width: auto;" onclick="addOrUpdateMarkupPreset()"><i
                                    class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-database"></i> Управління Даними</h3>
                <button class="btn-primary" onclick="exportDataToJSON()"><i class="fa-solid fa-download"></i> Зробити
                    Бек-ап (JSON)</button>
                <h4 style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">Відновити Дані:
                </h4>
                <input type="file" id="importFileInput" accept=".json" style="margin-bottom: 10px;">
                <button class="btn-danger" onclick="importDataFromJSON()"><i class="fa-solid fa-upload"></i> Відновити з
                    Файлу</button>
                <h4 style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">Синхронізація
                    (Text):</h4>
                <button class="btn-warning" onclick="showSyncModal()"><i class="fa-solid fa-link"></i> Відкрити Модальне
                    вікно</button>
            </div>
        </section>

        <section id="ai-assistant" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-robot"></i> AI Універсальний Помічник</h2>
                <p style="color:var(--text-muted); margin-bottom: 15px;">Я — ваш персональний менеджер. Вставте діалог з
                    клієнтом, і я допоможу з порадами, розрахунками та підбором ароматів.</p>

                <div class="parser-area" style="min-height: 200px; display: flex; flex-direction: column;">
                    <textarea id="adminAiChatInput"
                        placeholder="Вставте діалог або запитання тут (напр: 'Порадь щось схоже на Baccarat Rouge та порахуй олх доставку')..."
                        style="flex-grow: 1; min-height: 120px;"></textarea>
                    <button class="btn-primary" style="margin-top: 10px;" onclick="runAdminAI()">
                        <i class="fa-solid fa-paper-plane"></i> Запитати AI
                    </button>
                </div>

                <div id="adminAiResponse" class="card"
                    style="display: none; background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid var(--primary); margin-top: 20px;">
                    <div style="font-weight: 700; margin-bottom: 10px; color: var(--primary);">🤖 Відповідь AI:</div>
                    <div id="adminAiResponseContent" style="line-height: 1.6; white-space: pre-wrap;"></div>
                </div>
            </div>
        </section>

        <section id="smm-creator" class="content-section">
            <div class="card">
                <h2><i class="fa-brands fa-telegram"></i> SMM Creator - Telegram</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Створюйте та публікуйте картки парфумів в Telegram з AI-підтримкою
                </p>

                <div class="grid-2-col">
                    <div>
                        <h3 style="margin-top: 0;">📋 Налаштування картки</h3>
                        <label>Оберіть парфум:</label>
                        <select id="smmPerfumeSelect"></select>
                        <label style="margin-top: 15px;">Завантажте фото:</label>
                        <input type="file" id="smmPhotoUpload" accept="image/*"
                            style="padding: 10px; border: 2px dashed var(--border); border-radius: 6px;">
                        <button class="btn-primary" onclick="generateSMMPreview()"
                            style="margin-top: 20px; width: 100%;">
                            <i class="fa-solid fa-robot"></i> 🤖 Згенерувати превью з AI
                        </button>
                    </div>
                    <div>
                        <h3 style="margin-top: 0;">👁️ Превью</h3>
                        <div id="smmPreviewArea"
                            style="border: 1px solid var(--border); border-radius: 8px; padding: 15px; min-height: 300px; background: var(--bg-input);">
                            <p style="text-align: center; color: var(--text-muted); padding: 40px;">Превью з'явиться тут
                            </p>
                        </div>
                        <button class="btn-secondary" onclick="postToTelegram()" style="margin-top: 15px; width: 100%;">
                            <i class="fa-brands fa-telegram"></i> Опублікувати в Telegram
                        </button>
                    </div>
                </div>

                <!-- Quick Auto-Post Section -->
                <div
                    style="margin-top: 30px; padding: 20px; background: rgba(245, 158, 11, 0.1); border-radius: 12px; border-left: 4px solid var(--secondary);">
                    <h3 style="margin-top: 0; color: var(--secondary);">
                        <i class="fa-solid fa-fire"></i> Швидкий пост
                    </h3>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px;">
                        Автоматично згенерує та опублікує пост з топ-5 найпопулярніших ароматів
                    </p>
                    <button class="btn-warning" onclick="postTopProductsToTelegram()" style="width: 100%;">
                        <i class="fa-solid fa-fire"></i> Топ-5 в Telegram
                    </button>
                </div>
            </div>
        </section>

        <section id="expenses" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-money-bill-wave"></i> Додати Витрату</h2>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>Опис витрати</label><input type="text" id="expenseDescription"
                            placeholder="Напр: Нова Пошта за тиждень"></div>
                    <div><label>Сума (₴)</label><input type="number" id="expenseAmount" placeholder="Напр: 150.50">
                    </div>
                </div>
                <button class="btn-danger" onclick="addExpense()"><i class="fa-solid fa-minus-circle"></i> Зафіксувати
                    Витрату</button>
                <div id="expenseListOutput" style="margin-top: 20px;"></div>
            </div>
        </section>

        <section id="calculator" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-calculator"></i> Калькулятор ціни</h2>
                <div class="grid-3-col" style="margin-bottom: 15px;">
                    <div><label>Парфум</label><input type="text" id="calcPerfumeName" list="perfumeList"></div>
                    <div><label>Об'єм</label><select id="calcFlaconVolume"></select></div>
                    <div><label>Націнка</label><select id="calcMarkupTier"></select></div>
                </div>
                <button class="btn-primary" onclick="calculateRetailPrice()"><i class="fa-solid fa-search-dollar"></i>
                    Розрахувати</button>
                <div id="calculatorOutput" style="margin-top: 20px;"></div>
            </div>
        </section>

    </div>

    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header no-print">
                <h3 style="margin:0;">Чек-ордер</h3>
                <button class="btn-sm" style="width:auto" onclick="closeReceiptModal()">✕</button>
            </div>
            <div class="modal-body" id="receiptContent"></div>
        </div>
    </div>

    <div id="syncModal" class="modal">
        <div class="modal-content">
            <div class="modal-header no-print">
                <h3 style="margin:0;">Синхронізація Даних</h3>
                <button class="btn-sm" style="width:auto" onclick="closeSyncModal()">✕</button>
            </div>
            <div class="modal-body">
                <p>Скопіюйте цей текст для відновлення на іншому пристрої.</p>
                <textarea id="syncDataOutput" rows="15" readonly
                    style="width: 100%; resize: none; font-size: 0.75rem;"></textarea>
                <button class="btn-success" style="margin-top: 10px;" onclick="copySyncData()"><i
                        class="fa-solid fa-copy"></i> Копіювати</button>
                <p style="margin-top: 20px; border-top: 1px dashed var(--border); padding-top: 15px;">**АБО ВСТАВИТИ ДЛЯ
                    ІМПОРТУ:**</p>
                <textarea id="syncDataInput" rows="5" placeholder="Вставте скопійовані дані сюди..."
                    style="width: 100%; resize: none;"></textarea>
                <button class="btn-warning" style="margin-top: 10px;" onclick="importDataFromSync()"><i
                        class="fa-solid fa-upload"></i> Відновити</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL (AI API) -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ Налаштування</h3>
                <button onclick="closeSettingsModal()" class="btn-sm btn-danger">X</button>
            </div>
            <div class="modal-body">
                <label>🔑 Gemini API Key:</label>
                <input type="text" id="apiKeyInput" value="AIzaSyDYtCM1M61MG18zX3KZD2jfwofLmKvPG9U"
                    placeholder="AIzaSy..." onchange="saveApiKey(this.value)">
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                    Ключ зберігається лише у вашому браузері (Local Storage). <br>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank">Отримати ключ Gemini</a>
                </p>
                <div
                    style="background: rgba(var(--primary-rgb), 0.1); padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 3px solid var(--primary);">
                    <label>🤖 Модель ШІ:</label>
                    <select id="geminiModelSelect" onchange="localStorage.setItem('gemini_model', this.value)"
                        style="margin-top: 5px;">
                        <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash-Lite (Краща квота)</option>
                        <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (Найновіша)</option>
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash (Швидка)</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash (Потужна)</option>
                    </select>
                </div>

                <h3>📱 Telegram Bot</h3>
                <label>Bot Token:</label>
                <input type="text" id="telegramBotTokenInput" placeholder="1234567890:ABCD..."
                    onchange="saveTelegramConfig()">

                <label style="margin-top: 10px;">Channel ID:</label>
                <input type="text" id="telegramChannelIdInput" placeholder="@channel або -1001234567890"
                    onchange="saveTelegramConfig()">

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-success" onclick="testTelegramConnection()">🔌 Тест підключення</button>
                </div>

                <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">

                <h3>☁️ Хмара (Supabase)</h3>
                <label>Project URL:</label>
                <input type="text" id="supabaseUrlInput" placeholder="https://xyz.supabase.co"
                    onchange="saveSupabaseConfig()">

                <label style="margin-top: 10px;">API Key (public/anon):</label>
                <input type="password" id="supabaseKeyInput" placeholder="eyJhbGciOiJIUzI1NiIsIn..."
                    onchange="saveSupabaseConfig()">

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-success" onclick="testSupabaseConnection()">🔌 Перевірити з'єднання</button>
                    <button class="btn-warning" onclick="syncWithCloud()">☁️ Зберегти в хмару</button>
                    <button class="btn-danger" onclick="loadFromCloud()">📥 Відновити з хмари</button>
                </div>

                <!-- Sync Status Display -->
                <div id="syncStatusDisplay" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- FAB (Floating Action Button) -->
    <div class="fab-container">
        <button class="fab-button" onclick="toggleFabMenu()" aria-label="Швидкі дії">
            <i class="fa-solid fa-plus" id="fab-icon"></i>
        </button>
        <div class="fab-menu" id="fabMenu">
            <button class="fab-menu-item" onclick="fabAction('order')" title="Створити замовлення">
                <i class="fa-solid fa-basket-shopping"></i>
                <span>Замовлення</span>
            </button>
            <button class="fab-menu-item" onclick="fabAction('scan')" title="Сканувати штрих-код">
                <i class="fa-solid fa-barcode"></i>
                <span>Скан</span>
            </button>
            <button class="fab-menu-item" onclick="fabAction('task')" title="Додати задачу">
                <i class="fa-solid fa-clipboard-list"></i>
                <span>Задача</span>
            </button>
        </div>
    </div>

    <datalist id="perfumeList"></datalist>
    <datalist id="clientList"></datalist>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="app.js"></script>
    <script src="telegram.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('ServiceWorker registration successful'))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
    </script>
</body>

</html>